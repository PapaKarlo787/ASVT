org 100h
jmp _start

int9:
	pushf
	call far [cs:old_int9]
	push ax
	push fs
	push bx
	push di
	
	in al, 60h
	cmp al, 127 ; keyup
	jg .int9_end
	
	cmp al, 0x1d ; Ctrl
	jne .int9_skip_switch
	
	mov ax, [cs:cur_lang]
	xor ax, 1
	mov word [cs:cur_lang], ax
.int9_skip_switch:
	mov ax, [cs:cur_lang]
	cmp ax, 1
	jne .int9_end
	
	xor ax, ax
	push 0
	pop fs
	
	mov bx, [fs:0x41c]
	and bx, 31
	add bx, 30
	mov al, [fs:0x400 + bx]
	cmp al, 127
	jg .int9_end
	cmp al, 32
	jl .int9_end
	
	sub al, 32
	mov di, ax
	mov al, [cs:table + di]
	mov [fs:0x400 + bx], al
.int9_end:
	pop di
	pop bx
	pop fs
	mov al, 20h
	out 20h, al
	pop ax
	iret

cur_lang: dw 0

old_int9: dw 0, 0

table:
	db 0x20, 0x21, 0x9D, 0xFB, 0x3B, 0x25, 0x3F, 0xED, 0x28, 0x29, 0x2A, 0x3D, 0xA1, 0x2D, 0xEE, 0x2E
	db 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x86, 0xA6, 0x81, 0x3D, 0x9E, 0x2C
	db 0x22, 0x94, 0x88, 0x91, 0x82, 0x93, 0x80, 0x8F, 0x90, 0x98, 0x8E, 0x8B, 0x84, 0x9C, 0x92, 0x99
	db 0x87, 0x89, 0x8A, 0x9B, 0x85, 0x83, 0x8C, 0x96, 0x97, 0x8D, 0x9F, 0xE5, 0x5C, 0xEA, 0x3A, 0x5F
	db 0xF1, 0xE4, 0xA8, 0xE1, 0xA2, 0xE3, 0xA0, 0xAF, 0xE0, 0xE8, 0xAE, 0xAB, 0xA4, 0xEC, 0xE2, 0xE9
	db 0xA7, 0xA9, 0xAA, 0xEB, 0xA5, 0xA3, 0xAC, 0xE6, 0xE7, 0xAD, 0xEF, 0x95, 0x2F, 0x9A, 0xF0

_start:
	mov dx, _start
	pop fs
	mov ax, word [fs:9 * 4]
	mov [old_int9], ax
	mov ax, word [fs:9 * 4 + 2]
	mov [old_int9 + 2], ax
	cli
	mov word [fs:9 * 4], int9
	mov word [fs:9 * 4 + 2], cs
	sti
	int 27h

